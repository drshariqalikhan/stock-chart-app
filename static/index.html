<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock P/E Tracker</title>
    <link rel="manifest" href='data:application/manifest+json,{"name":"StockPE","short_name":"StockPE","start_url":"/","display":"standalone","background_color":"#1a1a1a","theme_color":"#1a1a1a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2422/2422796.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; min-height: 100vh; padding-bottom: 50px; }
        .title, .label, .subtitle { color: #fff !important; }
        .card { background-color: #2c2c2c; border: 1px solid #444; margin-bottom: 20px; }
        .input { background-color: #383838; border-color: #555; color: #fff; }
        .button.is-primary { background-color: #00d1b2; color: #1a1a1a; font-weight: bold; }
        .button.is-warning { font-weight: bold; margin-top: 10px; }
        .chart-main { height: 45vh; position: relative; }
        .chart-pe { height: 25vh; position: relative; }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title has-text-centered">ðŸ“ˆ Stock Weekly & P/E</h1>
            
            <div class="columns is-centered">
                <div class="column is-half">
                    <div class="card p-4">
                        <div class="field is-grouped">
                            <p class="control is-expanded">
                                <label class="label is-small">Ticker</label>
                                <input class="input" type="text" id="tk" value="V">
                            </p>
                            <p class="control" style="width: 80px;">
                                <label class="label is-small">Years</label>
                                <input class="input" type="number" id="yr" value="5">
                            </p>
                            <p class="control">
                                <label class="label is-small" style="visibility:hidden">.</label>
                                <button class="button is-primary" id="go">Load Data</button>
                            </p>
                        </div>
                        <!-- Separate line for Channel Button to ensure visibility -->
                        <button class="button is-warning is-fullwidth" id="channelBtn">Draw Price Channel</button>
                    </div>
                </div>
            </div>

            <div class="card p-4">
                <h2 class="subtitle is-6">Price ($)</h2>
                <div class="chart-main"><canvas id="c1"></canvas></div>
            </div>
            
            <div class="card p-4">
                <h2 class="subtitle is-6">P/E Ratio (TTM)</h2>
                <div class="chart-pe"><canvas id="c2"></canvas></div>
            </div>
        </div>
    </section>

    <script>
        let ch1 = null, ch2 = null, globalData = null;

        document.getElementById('go').onclick = async () => {
            const btn = document.getElementById('go');
            const s = document.getElementById('tk').value;
            const y = document.getElementById('yr').value;
            btn.classList.add('is-loading');
            try {
                const r = await fetch(`/api/stock?symbol=${s}&years=${y}`);
                globalData = await r.json();
                if (!r.ok) throw new Error(globalData.error);
                render(globalData);
            } catch (e) { alert(e.message); }
            finally { btn.classList.remove('is-loading'); }
        };

        document.getElementById('channelBtn').onclick = () => {
            if (!globalData) return alert("Please load stock data first.");
            drawChannel(globalData);
        };

        function render(d) {
            const opt = { 
                responsive:true, maintainAspectRatio:false, animation: false,
                plugins:{legend:{display:false}}, 
                scales:{x:{grid:{display:false}}, y:{grid:{color:'#333'}}} 
            };
            Chart.defaults.color = '#888';
            if (ch1) ch1.destroy();
            ch1 = new Chart(document.getElementById('c1'), { 
                type:'line', 
                data:{ labels:d.labels, datasets:[{ id:'main', data:d.prices, borderColor:'#00d1b2', pointRadius:0, fill:true, backgroundColor:'rgba(0,209,178,0.1)' }] }, 
                options:opt 
            });
            if (ch2) ch2.destroy();
            ch2 = new Chart(document.getElementById('c2'), { 
                type:'line', data:{labels:d.labels, datasets:[{data:d.peRatios, borderColor:'#ffe08a', pointRadius:0}]}, options:opt 
            });
        }

        function drawChannel(d) {
            const p = d.prices, pe = d.peRatios, n = p.length;
            const valid = pe.filter(v => v !== null);
            if (valid.length < 2) return alert("Insufficient P/E data.");
            
            const min = Math.min(...valid);
            const candidates = [];
            for(let i=0; i<n; i++) if(pe[i] !== null && pe[i] <= min * 1.02) candidates.push(i);

            let bS = 0, bI = 0, maxH = 0;
            for(let i=0; i<candidates.length; i++) {
                for(let j=i+1; j<candidates.length; j++) {
                    const idx1 = candidates[i], idx2 = candidates[j];
                    const slope = (p[idx2] - p[idx1]) / (idx2 - idx1);
                    const inter = p[idx1] - (slope * idx1);
                    let hits = 0;
                    candidates.forEach(k => {
                        if(Math.abs(p[k] - (slope*k + inter)) < p[k] * 0.01) hits++;
                    });
                    if(hits > maxH) { maxH = hits; bS = slope; bI = inter; }
                }
            }

            let maxU = -Infinity;
            for(let i=0; i<n; i++) {
                let inter = p[i] - (bS * i);
                if(inter > maxU) maxU = inter;
            }

            // Clean existing lines
            ch1.data.datasets = ch1.data.datasets.filter(ds => ds.id === 'main');
            const common = { pointRadius:0, borderWidth:2, borderDash:[5,5], fill:false };
            ch1.data.datasets.push({ label:'Support', data:p.map((_,i)=>bS*i+bI), borderColor:'#ff4d4d', ...common });
            ch1.data.datasets.push({ label:'Resistance', data:p.map((_,i)=>bS*i+maxU), borderColor:'#ff4d4d', ...common });
            ch1.update();
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
    </script>
</body>
</html>