<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis PWA</title>
    <link rel="manifest" href='data:application/manifest+json,{"name":"StockPE","short_name":"StockPE","start_url":"/","display":"standalone","background_color":"#1a1a1a","theme_color":"#1a1a1a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2422/2422796.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; min-height: 100vh; padding-bottom: 50px; }
        .title, .label, .subtitle { color: #ffffff !important; }
        .card { background-color: #2c2c2c; border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.5); margin-bottom: 25px; }
        .input { background-color: #383838; border-color: #555; color: #fff; }
        .button.is-primary { background-color: #00d1b2; color: #1a1a1a; font-weight: bold; border: none; }
        .button.is-warning { background-color: #ffdd57; color: #1a1a1a; font-weight: bold; margin-top: 10px; }
        .chart-container-main { position: relative; height: 45vh; width: 100%; }
        .chart-container-pe { position: relative; height: 25vh; width: 100%; }
        #eventLog { height: 120px; overflow-y: auto; background-color: #000; color: #00ff00; font-family: 'Courier New', monospace; font-size: 0.8rem; padding: 10px; border: 1px solid #444; border-radius: 4px; }
        .log-info { color: #aaa; } .log-success { color: #00d1b2; } .log-error { color: #ff3860; } .log-warn { color: #ffdd57; }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title has-text-centered">ðŸ“ˆ Stock Analysis & EMA</h1>
            <div class="columns is-centered">
                <div class="column is-half">
                    <div class="card p-4">
                        <div class="field is-grouped">
                            <p class="control is-expanded"><label class="label is-small">Ticker</label><input class="input" type="text" id="tk" value="V"></p>
                            <p class="control" style="width: 100px;"><label class="label is-small">Years</label><input class="input" type="number" id="yr" value="5"></p>
                            <p class="control"><label class="label is-small" style="visibility:hidden">.</label><button class="button is-primary" id="go">Load Data</button></p>
                        </div>
                        <button class="button is-warning is-fullwidth" id="channelBtn">Draw Price Channel</button>
                    </div>
                </div>
            </div>
            <div class="card p-4"><h2 class="subtitle is-6 mb-2">Price & EMAs ($)</h2><div class="chart-container-main"><canvas id="c1"></canvas></div></div>
            <div class="card p-4"><h2 class="subtitle is-6 mb-2">P/E Ratio (TTM)</h2><div class="chart-container-pe"><canvas id="c2"></canvas></div></div>
            <div class="card p-4"><h2 class="subtitle is-6 mb-2">System Events</h2><div id="eventLog"></div></div>
        </div>
    </section>

    <script>
        let ch1 = null, ch2 = null, globalData = null;
        function addLog(msg, type = 'info') {
            const l = document.getElementById('eventLog'), e = document.createElement('div');
            e.className = `log-${type}`; e.innerHTML = `<span style="color:#666">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            l.appendChild(e); l.scrollTop = l.scrollHeight;
        }

        document.getElementById('go').onclick = async () => {
            const s = document.getElementById('tk').value.trim().toUpperCase(), y = document.getElementById('yr').value;
            addLog(`Fetching ${s}...`); document.getElementById('go').classList.add('is-loading');
            try {
                const r = await fetch(`/api/stock?symbol=${s}&years=${y}`);
                globalData = await r.json();
                if (!r.ok) throw new Error(globalData.error);
                renderCharts(globalData);
                addLog(`Success: Data for ${s} loaded.`, 'success');
            } catch (e) { addLog(`Error: ${e.message}`, 'error'); }
            finally { document.getElementById('go').classList.remove('is-loading'); }
        };

        function renderCharts(d) {
            Chart.defaults.color = '#999'; Chart.defaults.borderColor = '#333';
            const opt = { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: true, labels: { color: '#fff', boxWidth: 12 } } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#333' } } } };

            if (ch1) ch1.destroy();
            ch1 = new Chart(document.getElementById('c1'), {
                type: 'line',
                data: {
                    labels: d.labels,
                    datasets: [
                        { id: 'mainPrice', label: 'Price', data: d.prices, borderColor: '#00d1b2', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 },
                        { label: '50wk EMA', data: d.ema50, borderColor: '#ffffff', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.1 },
                        { label: '100wk EMA', data: d.ema100, borderColor: '#ff3860', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.1 }
                    ]
                },
                options: opt
            });

            if (ch2) ch2.destroy();
            ch2 = new Chart(document.getElementById('c2'), {
                type: 'line',
                data: { labels: d.labels, datasets: [{ label: 'P/E TTM', data: d.peRatios, borderColor: '#ffe08a', borderWidth: 2, pointRadius: 0 }] },
                options: { ...opt, plugins: { legend: { display: false } } }
            });
        }

        document.getElementById('channelBtn').onclick = () => {
            if (!globalData || !ch1) return addLog("Load data first!", "warn");
            addLog("Calculating Channel...");
            const p = globalData.prices, pe = globalData.peRatios, n = p.length;
            const validPes = pe.filter(v => v !== null).sort((a,b) => a - b);
            const threshold = validPes[Math.floor(validPes.length * 0.10)];
            const candidates = [];
            for(let i=0; i<n; i++) if(pe[i] !== null && pe[i] <= threshold) candidates.push(i);

            let bS = 0, bI = 0, maxH = -1;
            for(let i=0; i < candidates.length; i++) {
                for(let j=i+1; j < candidates.length; j++) {
                    const idx1 = candidates[i], idx2 = candidates[j];
                    const slope = (p[idx2] - p[idx1]) / (idx2 - idx1), inter = p[idx1] - (slope * idx1);
                    let hits = 0;
                    candidates.forEach(k => { if(Math.abs(p[k] - (slope*k + inter)) < p[k] * 0.02) hits++; });
                    if(hits > maxH) { maxH = hits; bS = slope; bI = inter; }
                }
            }
            let maxU = -Infinity;
            for(let i=0; i<n; i++) { let curr = p[i] - (bS * i); if(curr > maxU) maxU = curr; }

            // Re-render price chart but keep EMAs
            const style = { pointRadius:0, borderWidth:1, borderDash:[5,5], fill:false, tension:0 };
            ch1.data.datasets = ch1.data.datasets.filter(ds => !ds.label.includes('Support') && !ds.label.includes('Resistance'));
            ch1.data.datasets.push({ label: 'Support', data: p.map((_, i) => (bS * i) + bI), borderColor: '#ffdd57', ...style });
            ch1.data.datasets.push({ label: 'Resistance', data: p.map((_, i) => (bS * i) + maxU), borderColor: '#ffdd57', ...style });
            ch1.update();
            addLog(`Channel drawn based on ${maxH} low-P/E hits.`, 'success');
        };

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
    </script>
</body>
</html>