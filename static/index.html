<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock P/E Tracker</title>
    <!-- Inline Manifest Data URI -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"StockPE","short_name":"StockPE","start_url":"/","display":"standalone","background_color":"#1a1a1a","theme_color":"#1a1a1a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2422/2422796.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="theme-color" content="#1a1a1a">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; min-height: 100vh; }
        .title, .label, .subtitle { color: #fff !important; }
        .card { background-color: #2c2c2c; border: 1px solid #444; margin-bottom: 20px; }
        .input { background-color: #383838; border-color: #555; color: #fff; }
        .button.is-primary { background-color: #00d1b2; color: #1a1a1a; font-weight: bold; }
        .chart-main { height: 40vh; position: relative; }
        .chart-pe { height: 25vh; position: relative; }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title has-text-centered">ðŸ“‰ Stock Weekly & P/E</h1>
            <div class="columns is-centered">
                <div class="column is-half">
                    <div class="card p-4">
                        <div class="field is-grouped">
                            <p class="control is-expanded"><input class="input" type="text" id="tk" value="V"></p>
                            <p class="control" style="width: 80px;"><input class="input" type="number" id="yr" value="5"></p>
                            <p class="control"><button class="button is-primary" id="go">Load</button></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card p-4"><h2 class="subtitle is-6">Price ($)</h2><div class="chart-main"><canvas id="c1"></canvas></div></div>
            <div class="card p-4"><h2 class="subtitle is-6">P/E Ratio (TTM)</h2><div class="chart-pe"><canvas id="c2"></canvas></div></div>
        </div>
    </section>

    <script>
        let ch1 = null, ch2 = null;
        const btn = document.getElementById('go');

        btn.onclick = async () => {
            const s = document.getElementById('tk').value;
            const y = document.getElementById('yr').value;
            btn.classList.add('is-loading');
            try {
                const r = await fetch(`/api/stock?symbol=${s}&years=${y}`);
                const d = await r.json();
                if (!r.ok) throw new Error(d.error);
                render(d);
            } catch (e) { alert(e.message); }
            finally { btn.classList.remove('is-loading'); }
        };

        function render(d) {
            const opt = { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#333'}}} };
            Chart.defaults.color = '#888';
            if (ch1) ch1.destroy();
            ch1 = new Chart(document.getElementById('c1'), { type:'line', data:{labels:d.labels, datasets:[{data:d.prices, borderColor:'#00d1b2', pointRadius:0, fill:true, backgroundColor:'rgba(0,209,178,0.1)'}]}, options:opt });
            if (ch2) ch2.destroy();
            ch2 = new Chart(document.getElementById('c2'), { type:'line', data:{labels:d.labels, datasets:[{data:d.peRatios, borderColor:'#ffe08a', pointRadius:0}]}, options:opt });
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>